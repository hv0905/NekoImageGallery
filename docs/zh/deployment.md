# éƒ¨ç½²

## ğŸ“¦ å…ˆå†³æ¡ä»¶

### ç¡¬ä»¶è¦æ±‚

| ç¡¬ä»¶ | æœ€ä½è¦æ±‚ | æ¨èè¦æ±‚ |
|---|---|---|
| CPU | X86_64æˆ–ARM64 CPUï¼Œ2æ ¸æˆ–æ›´å¤š | 4æ ¸æˆ–æ›´å¤š |
| å†…å­˜ | 4GBæˆ–æ›´å¤š | 8GBæˆ–æ›´å¤š |
| å­˜å‚¨ | 10GBæˆ–æ›´å¤šç”¨äºåº“ã€æ¨¡å‹å’Œæ•°æ® | 50GBæˆ–æ›´å¤šï¼Œæ¨èä½¿ç”¨SSD |
| GPU | ä¸éœ€è¦ | æ”¯æŒCUDAçš„GPUç”¨äºåŠ é€Ÿï¼Œ4GBæˆ–æ›´å¤šæ˜¾å­˜ |

### è½¯ä»¶è¦æ±‚

- æœ¬åœ°éƒ¨ç½²ï¼šPython 3.10 ~ Python 3.12ï¼Œå¹¶å·²å®‰è£… [uvåŒ…ç®¡ç†å™¨](https://docs.astral.sh/uv/getting-started/installation/)ã€‚
- Dockeréƒ¨ç½²ï¼šDockerå’ŒDocker Composeï¼ˆå¯¹äºCUDAç”¨æˆ·ï¼Œéœ€è¦`nvidia-container-runtime`ï¼‰æˆ–ç­‰æ•ˆçš„å®¹å™¨è¿è¡Œæ—¶ã€‚

## ğŸ–¥ï¸ æœ¬åœ°éƒ¨ç½²

### é€‰æ‹©å…ƒæ•°æ®å­˜å‚¨æ–¹å¼

#### Qdrantæ•°æ®åº“ï¼ˆæ¨èï¼‰

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨Qdrantæ•°æ®åº“æ¥å­˜å‚¨å…ƒæ•°æ®ã€‚Qdrantæ•°æ®åº“æä¾›é«˜æ•ˆçš„æ£€ç´¢æ€§èƒ½ã€çµæ´»çš„å¯æ‰©å±•æ€§å’Œæ›´å¥½çš„æ•°æ®å®‰å…¨æ€§ã€‚

è¯·æ ¹æ®[Qdrantæ–‡æ¡£](https://qdrant.tech/documentation/quick-start/)éƒ¨ç½²Qdrantæ•°æ®åº“ã€‚å»ºè®®ä½¿ç”¨Dockerè¿›è¡Œéƒ¨ç½²ã€‚

å¦‚æœæ‚¨ä¸æƒ³è‡ªå·±éƒ¨ç½²Qdrantï¼Œå¯ä»¥ä½¿ç”¨[Qdrantæä¾›çš„åœ¨çº¿æœåŠ¡](https://qdrant.tech/documentation/cloud/)ã€‚

#### æœ¬åœ°æ–‡ä»¶å­˜å‚¨

æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç›´æ¥å°†å›¾åƒå…ƒæ•°æ®ï¼ˆåŒ…æ‹¬ç‰¹å¾å‘é‡ç­‰ï¼‰å­˜å‚¨åœ¨æœ¬åœ°SQLiteæ•°æ®åº“ä¸­ã€‚ä»…å»ºè®®ç”¨äºå°è§„æ¨¡éƒ¨ç½²æˆ–å¼€å‘éƒ¨ç½²ã€‚

æœ¬åœ°æ–‡ä»¶å­˜å‚¨ä¸éœ€è¦é¢å¤–çš„æ•°æ®åº“éƒ¨ç½²è¿‡ç¨‹ï¼Œä½†æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š

- æœ¬åœ°å­˜å‚¨ä¸å¯¹å‘é‡è¿›è¡Œç´¢å¼•å’Œä¼˜åŒ–ï¼Œå› æ­¤æ‰€æœ‰æœç´¢çš„æ—¶é—´å¤æ‚åº¦å‡ä¸º`O(n)`ã€‚å› æ­¤ï¼Œå¦‚æœæ•°æ®è§„æ¨¡è¾ƒå¤§ï¼Œæœç´¢å’Œç´¢å¼•çš„æ€§èƒ½ä¼šä¸‹é™ã€‚
- ä½¿ç”¨æœ¬åœ°æ–‡ä»¶å­˜å‚¨ä¼šä½¿NekoImageGalleryå˜ä¸ºæœ‰çŠ¶æ€ï¼Œä»è€Œå¤±å»æ°´å¹³å¯æ‰©å±•æ€§ã€‚
- å½“æ‚¨æƒ³è¿ç§»åˆ°Qdrantæ•°æ®åº“è¿›è¡Œå­˜å‚¨æ—¶ï¼Œå·²ç´¢å¼•çš„å…ƒæ•°æ®å¯èƒ½éš¾ä»¥ç›´æ¥è¿ç§»ã€‚

### éƒ¨ç½²NekoImageGallery

> [!NOTE]
> æœ¬æ•™ç¨‹é€‚ç”¨äºNekoImageGallery v1.4.0åŠæ›´é«˜ç‰ˆæœ¬ï¼Œå…¶ä¸­æˆ‘ä»¬åˆ‡æ¢åˆ°`uv`ä½œä¸ºåŒ…ç®¡ç†å™¨ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æ—©æœŸç‰ˆæœ¬ï¼Œè¯·å‚é˜…ç›¸åº”ç‰ˆæœ¬æ ‡ç­¾ä¸­çš„READMEæ–‡ä»¶ã€‚

1. å°†é¡¹ç›®ç›®å½•å…‹éš†åˆ°æ‚¨è‡ªå·±çš„PCæˆ–æœåŠ¡å™¨ä¸Šï¼Œç„¶ååˆ‡æ¢åˆ°ç‰¹å®šçš„ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚`v1.4.0`ï¼‰ã€‚
2. å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ï¼š

    ```shell
    uv sync --no-dev --extra cpu # ä»…CPUéƒ¨ç½²
    
    uv sync --no-dev --extra cu124 # CUDA v12.4éƒ¨ç½²
    
    uv sync --no-dev --extra cu118 # CUDA v11.8éƒ¨ç½²
    ```

> [!NOTE]
>
> - éœ€è¦æŒ‡å®š`--extra`é€‰é¡¹æ¥å®‰è£…æ­£ç¡®çš„ä¾èµ–é¡¹ã€‚å¦‚æœæ‚¨ä¸æŒ‡å®š`--extra`é€‰é¡¹ï¼ŒPyTorchåŠå…¶ç›¸å…³ä¾èµ–é¡¹å°†ä¸ä¼šè¢«å®‰è£…ã€‚
> - å¦‚æœæ‚¨æƒ³ä½¿ç”¨CUDAè¿›è¡ŒåŠ é€Ÿæ¨ç†ï¼Œè¯·åŠ¡å¿…åœ¨æ­¤æ­¥éª¤ä¸­é€‰æ‹©å¯ç”¨CUDAçš„extraå˜ä½“ï¼ˆæˆ‘ä»¬æ¨è`cu124`ï¼Œé™¤éæ‚¨çš„å¹³å°ä¸æ”¯æŒcuda12+ï¼‰ã€‚å®‰è£…åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`torch.cuda.is_available()`æ¥ç¡®è®¤CUDAæ˜¯å¦å¯ç”¨ã€‚
> - å¦‚æœæ‚¨æ­£åœ¨å¼€å‘æˆ–æµ‹è¯•ï¼Œå¯ä»¥åœ¨ä¸å¸¦`--no-dev`å¼€å…³çš„æƒ…å†µä¸‹åŒæ­¥ï¼Œä»¥å®‰è£…å¼€å‘ã€æµ‹è¯•å’Œä»£ç æ£€æŸ¥æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚

3. æ ¹æ®éœ€è¦ä¿®æ”¹`config`ç›®å½•ä¸­çš„é…ç½®æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ç›´æ¥ä¿®æ”¹`default.env`ï¼Œä½†å»ºè®®åˆ›å»ºä¸€ä¸ªåä¸º`local.env`çš„æ–‡ä»¶æ¥è¦†ç›–`default.env`ä¸­çš„é…ç½®ã€‚
4. ï¼ˆå¯é€‰ï¼‰å¯ç”¨å†…ç½®å‰ç«¯ï¼š
   NekoImageGallery v1.5.0+å…·æœ‰åŸºäº[NekoImageGallery.App](https://github.com/hv0905/NekoImageGallery.App)çš„å†…ç½®å‰ç«¯åº”ç”¨ç¨‹åºã€‚
   è¦å¯ç”¨å®ƒï¼Œè¯·åœ¨æ‚¨çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®`APP_WITH_FRONTEND=True`ã€‚
   > [!WARNING]
   > å¯ç”¨å†…ç½®å‰ç«¯åï¼Œæ‰€æœ‰APIå°†è‡ªåŠ¨æŒ‚è½½åˆ°`/api`å­è·¯å¾„ä¸‹ã€‚ä¾‹å¦‚ï¼ŒåŸæ¥çš„`/docs`å°†å˜ä¸º`/api/docs`ã€‚
   > è¿™å¯èƒ½ä¼šå½±å“æ‚¨ç°æœ‰çš„éƒ¨ç½²ï¼Œè¯·è°¨æ…æ“ä½œã€‚
5. è¿è¡Œåº”ç”¨ç¨‹åºï¼š

    ```shell
    uv run main.py
    ```

   æ‚¨å¯ä»¥ä½¿ç”¨`--host`æŒ‡å®šè¦ç»‘å®šçš„IPåœ°å€ï¼ˆé»˜è®¤ä¸º0.0.0.0ï¼‰ï¼Œä½¿ç”¨`--port`æŒ‡å®šè¦ç»‘å®šçš„ç«¯å£ï¼ˆé»˜è®¤ä¸º8000ï¼‰ã€‚
   æ‚¨å¯ä»¥ä½¿ç”¨`uv run main.py --help`æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„å‘½ä»¤å’Œé€‰é¡¹ã€‚
6. ï¼ˆå¯é€‰ï¼‰éƒ¨ç½²å‰ç«¯åº”ç”¨ç¨‹åºï¼šå¦‚æœæ‚¨ä¸æƒ³ä½¿ç”¨å†…ç½®å‰ç«¯ï¼Œæˆ–è€…æƒ³ç‹¬ç«‹éƒ¨ç½²å‰ç«¯ï¼Œå¯ä»¥å‚è€ƒ[NekoImageGallery.App](https://github.com/hv0905/NekoImageGallery.App)çš„[éƒ¨ç½²æ–‡æ¡£](https://github.com/hv0905/NekoImageGallery.App)ã€‚

## ğŸ‹ Dockeréƒ¨ç½²

### å…³äºDockeré•œåƒ

NekoImageGalleryçš„dockeré•œåƒåœ¨Docker Hubä¸Šæ„å»ºå’Œå‘å¸ƒï¼ŒåŒ…æ‹¬å‡ ä¸ªå˜ä½“ï¼š

| æ ‡ç­¾ | æè¿° |
|---|---|
| `edgeneko/neko-image-gallery:<version>`<br>`edgeneko/neko-image-gallery:<version>-cuda`<br>`edgeneko/neko-image-gallery:<version>-cuda12.4` | æ”¯æŒä½¿ç”¨CUDA12.4è¿›è¡ŒGPUæ¨ç† |
| `edgeneko/neko-image-gallery:<version>-cuda11.8` | æ”¯æŒä½¿ç”¨CUDA11.8è¿›è¡ŒGPUæ¨ç† |
| `edgeneko/neko-image-gallery:<version>-cpu` | æ”¯æŒCPUæ¨ç† |
| `edgeneko/neko-image-gallery:<version>-cpu-arm` | ï¼ˆAlphaï¼‰æ”¯æŒåœ¨ARM64ï¼ˆaarch64ï¼‰è®¾å¤‡ä¸Šè¿›è¡ŒCPUæ¨ç† |

å…¶ä¸­`<version>`æ˜¯NekoImageGalleryçš„ç‰ˆæœ¬å·æˆ–ç‰ˆæœ¬åˆ«åï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| ç‰ˆæœ¬ | æè¿° |
|---|---|
| `latest` | NekoImageGalleryçš„æœ€æ–°ç¨³å®šç‰ˆæœ¬ |
| `v*.*.*` / `v*.*` | ç‰¹å®šçš„ç‰ˆæœ¬å·ï¼ˆå¯¹åº”Gitæ ‡ç­¾ï¼‰ |
| `edge` | NekoImageGalleryçš„æœ€æ–°å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«ä¸ç¨³å®šåŠŸèƒ½å’Œé‡å¤§æ›´æ”¹ |

åœ¨æ¯ä¸ªé•œåƒä¸­ï¼Œæˆ‘ä»¬éƒ½æ†ç»‘äº†å¿…è¦çš„ä¾èµ–é¡¹ã€`openai/clip-vit-large-patch14`æ¨¡å‹æƒé‡ã€`bert-base-chinese`æ¨¡å‹æƒé‡å’Œ`easy-paddle-ocr`æ¨¡å‹ï¼Œä»¥æä¾›ä¸€ä¸ªå®Œæ•´ä¸”å³ç”¨å³å¾—çš„é•œåƒã€‚

é•œåƒä½¿ç”¨`/opt/NekoImageGallery/static`ä½œä¸ºå·æ¥å­˜å‚¨å›¾åƒæ–‡ä»¶ï¼Œå¦‚æœéœ€è¦æœ¬åœ°å­˜å‚¨ï¼Œè¯·å°†å…¶æŒ‚è½½åˆ°æ‚¨è‡ªå·±çš„å·æˆ–ç›®å½•ã€‚

å¯¹äºé…ç½®ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥è¦†ç›–é»˜è®¤é…ç½®ã€‚æœºå¯†ä¿¡æ¯ï¼ˆå¦‚APIä»¤ç‰Œï¼‰å¯ä»¥é€šè¿‡[docker secrets](https://docs.docker.com/engine/swarm/secrets/)æä¾›ã€‚

> [!NOTE]
> è¦å¯ç”¨å†…ç½®å‰ç«¯ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡`APP_WITH_FRONTEND=True`ã€‚
> å¯ç”¨åï¼Œæ‰€æœ‰APIå°†è‡ªåŠ¨æŒ‚è½½åˆ°`/api`å­è·¯å¾„ä¸‹ï¼Œè¯·ç¡®ä¿æ‚¨çš„åå‘ä»£ç†å’Œå…¶ä»–é…ç½®æ­£ç¡®ã€‚

### å‡†å¤‡`nvidia-container-runtime`

å¦‚æœæ‚¨æƒ³åœ¨æ¨ç†è¿‡ç¨‹ä¸­æ”¯æŒCUDAåŠ é€Ÿï¼Œè¯·å‚é˜…[Docker GPUç›¸å…³æ–‡æ¡£](https://docs.docker.com/config/containers/resource_constraints/#gpu)è¿›è¡Œå®‰è£…ã€‚

> ç›¸å…³æ–‡æ¡£ï¼š
>
> 1. <https://docs.docker.com/config/containers/resource_constraints/#gpu>
> 2. <https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker>
> 3. <https://nvidia.github.io/nvidia-container-runtime/>

### è¿è¡ŒæœåŠ¡å™¨

1. ä»å­˜å‚¨åº“ä¸‹è½½`docker-compose.yml`æ–‡ä»¶ã€‚

    ```shell
    # å¯¹äºcudaéƒ¨ç½²ï¼ˆé»˜è®¤ï¼‰
    wget https://raw.githubusercontent.com/hv0905/NekoImageGallery/master/docker-compose.yml
    # å¯¹äºä»…CPUéƒ¨ç½²
    wget https://raw.githubusercontent.com/hv0905/NekoImageGallery/master/docker-compose-cpu.yml && mv docker-compose-cpu.yml docker-compose.yml
    ```

2. æ ¹æ®éœ€è¦ä¿®æ”¹docker-compose.ymlæ–‡ä»¶ã€‚
3. è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¯åŠ¨æœåŠ¡å™¨ï¼š

    ```shell
    # åœ¨å‰å°å¯åŠ¨
    docker compose up
    # åœ¨åå°ï¼ˆåˆ†ç¦»æ¨¡å¼ï¼‰å¯åŠ¨
    docker compose up -d
    ```

### ä¸Šä¼ å›¾ç‰‡åˆ°NekoImageGallery

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å°†å›¾ç‰‡ä¸Šä¼ åˆ°NekoImageGalleryï¼š

- é€šè¿‡Webç•Œé¢ï¼šæ‚¨å¯ä»¥ä½¿ç”¨å†…ç½®çš„Webç•Œé¢æˆ–ç‹¬ç«‹çš„[NekoImageGallery.App](https://github.com/hv0905/NekoImageGallery.App)å°†å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚è¯·ç¡®ä¿æ‚¨å·²åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨äº†**Admin API**å¹¶è®¾ç½®äº†**Admin Token**ã€‚
- é€šè¿‡æœ¬åœ°ç´¢å¼•ï¼šè¿™é€‚ç”¨äºæœ¬åœ°éƒ¨ç½²æˆ–å½“æ‚¨è¦ä¸Šä¼ çš„å›¾ç‰‡å·²åœ¨æœåŠ¡å™¨ä¸Šæ—¶ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç´¢å¼•æ‚¨çš„æœ¬åœ°å›¾ç‰‡ç›®å½•ï¼š

  ```shell
  python main.py local-index <path-to-your-image-directory>
  ```

  ä»¥ä¸Šå‘½ä»¤å°†é€’å½’ä¸Šä¼ æŒ‡å®šç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ‰€æœ‰å›¾ç‰‡åˆ°æœåŠ¡å™¨ã€‚æ‚¨è¿˜å¯ä»¥ä¸ºæ‚¨ä¸Šä¼ çš„å›¾ç‰‡æŒ‡å®šç±»åˆ«/æ˜Ÿæ ‡ï¼Œæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…`python main.py local-index --help`ã€‚
- é€šè¿‡APIï¼šæ‚¨å¯ä»¥ä½¿ç”¨NekoImageGalleryæä¾›çš„ä¸Šä¼ APIæ¥ä¸Šä¼ å›¾ç‰‡ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼ŒæœåŠ¡å™¨å¯ä»¥é¿å…åœ¨æœ¬åœ°ä¿å­˜å›¾åƒæ–‡ä»¶ï¼Œè€Œåªå­˜å‚¨å®ƒä»¬çš„URLå’Œå…ƒæ•°æ®ã€‚
  è¯·ç¡®ä¿æ‚¨å·²åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨äº†**Admin API**å¹¶è®¾ç½®äº†**Admin Token**ã€‚æ­¤æ–¹æ³•é€‚ç”¨äºè‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡æˆ–å°†NekoImageGalleryä¸å¤–éƒ¨ç³»ç»ŸåŒæ­¥ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[APIæ–‡æ¡£](./api)ã€‚
